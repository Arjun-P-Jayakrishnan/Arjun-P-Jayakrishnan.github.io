{"version":3,"sources":["../src/gameplay/rooms/navigation/player.ts"],"names":["PLAYER_CONSTANTS","createPlayer","reference","storage","InputManager","controllers","state","Vector3","tempData","objects","mount","playerRoot","player","animations","err","updateMouse","mouse","updateKeyboard","keyboard","deltaTime","VELOCITY_DEADZONE","inputDirection","decay","FRICTION","updateControllers","Euler"],"mappings":"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","file":"chunk-WZU6CF5S.js","sourcesContent":["import { InputManager } from \"engine/managers/InputManager\";\nimport { GlobalStorageManager } from \"engine/managers/storage/storageTypes\";\nimport { KeyboardInput } from \"plugins/input/keyboard\";\nimport { MouseInput } from \"plugins/input/mouse\";\nimport { Euler, Object3D, Vector3 } from \"three\";\nimport { Nullable } from \"types/generic.types\";\nimport { GenericLifeCycle, ModelIdentifier } from \"types/rooms.types\";\n\nexport interface PlayerProps {\n  reference: ModelIdentifier;\n  storage: GlobalStorageManager;\n  InputManager: InputManager;\n}\n\nexport interface Player extends GenericLifeCycle {\n  /** Update based on controller input */\n  update: (deltaTime: number) => {\n    position: Vector3;\n    rotation: Euler;\n    rotationDelta: { yaw: number; pitch: number };\n  };\n}\n\ninterface PlayerState {\n  direction: Vector3;\n  velocity: Vector3;\n  rotationApplied: {\n    yaw: number;\n    pitch: number;\n  };\n}\n\ninterface Controllers {\n  input: {\n    mouse: Nullable<MouseInput>;\n    keyboard: Nullable<KeyboardInput>;\n  };\n}\n\ninterface ObjectReferences {\n  player: Nullable<Object3D>;\n}\n\nconst PLAYER_CONSTANTS = {\n  MOVEMENT_ACCELERATION: 0.05,\n  MAX_VELOCITY: 0.05,\n};\n\ninterface TempData {\n  inputDirection: Vector3;\n}\n\nexport const createPlayer = ({\n  reference,\n  storage,\n  InputManager,\n}: PlayerProps): Player => {\n  let controllers: Controllers;\n\n  let state: PlayerState = {\n    direction: new Vector3(0, 0, -1),\n    velocity: new Vector3(0, 0, 0),\n    rotationApplied: {\n      pitch: 0,\n      yaw: 0,\n    },\n  };\n  let tempData: TempData = {\n    inputDirection: new Vector3(0, 0, 0),\n  };\n\n  let objects: ObjectReferences = { player: null };\n\n  const mount = () => {\n    try {\n      const playerRoot = storage\n        .getStorage(\"model\")\n        .retrieve(reference.storageId);\n\n      if (!playerRoot) {\n        throw new Error(\n          `player doesn't exist for the id ${reference.storageId}`\n        );\n      }\n      const player = playerRoot?.groups;\n      const animations = playerRoot?.animations;\n\n      objects = {\n        player: player,\n      };\n\n      controllers = {\n        input: {\n          mouse: InputManager.getController(\"mouse\"),\n          keyboard: InputManager.getController(\"keyboard\"),\n        },\n      };\n    } catch (err) {\n      console.error(`Player mesh cant be obtained :${err}`);\n    }\n  };\n\n  const updateMouse = (mouse: Nullable<MouseInput>) => {\n    if (!mouse || !objects.player!) return;\n\n    state.rotationApplied = mouse.getRotation();\n    objects.player.rotation.y += state.rotationApplied.yaw;\n  };\n\n  const updateKeyboard = (\n    keyboard: Nullable<KeyboardInput>,\n    deltaTime: number\n  ) => {\n    if (!keyboard || !objects.player) return;\n    const FRICTION = 5.0;\n    const VELOCITY_DEADZONE = 0.001;\n\n    const { inputDirection } = tempData;\n    inputDirection.set(0, 0, 0);\n\n    if (keyboard.isKeyPressed(\"w\")) inputDirection.z -= 1;\n    if (keyboard.isKeyPressed(\"s\")) inputDirection.z += 1;\n    if (keyboard.isKeyPressed(\"a\")) inputDirection.x -= 1;\n    if (keyboard.isKeyPressed(\"d\")) inputDirection.x += 1;\n\n    if (inputDirection.length() > 0) {\n      //normalize direction\n      inputDirection.applyQuaternion(objects.player.quaternion);\n      inputDirection.normalize();\n\n      //accelerate towards the direction\n      state.velocity.add(\n        inputDirection.multiplyScalar(\n          PLAYER_CONSTANTS.MOVEMENT_ACCELERATION * deltaTime\n        )\n      );\n      //ensure the velocity doesn't go over the threshold\n      state.velocity.clampLength(0, PLAYER_CONSTANTS.MAX_VELOCITY);\n    } else if (inputDirection.length() == 0 && state.velocity.length() > 0) {\n      const decay = Math.exp(-FRICTION * deltaTime);\n      state.velocity.multiplyScalar(decay);\n\n      if (state.velocity.lengthSq() < VELOCITY_DEADZONE * VELOCITY_DEADZONE) {\n        state.velocity.set(0, 0, 0);\n      }\n    }\n\n    objects.player.position.add(state.velocity);\n  };\n\n  const updateControllers = (deltaTime: number) => {\n    updateMouse(controllers.input.mouse);\n    updateKeyboard(controllers.input.keyboard, deltaTime);\n  };\n\n  const update = (deltaTime: number) => {\n    updateControllers(deltaTime);\n\n    return {\n      position: objects.player?.position ?? new Vector3(0, 0, 0),\n      rotation: objects.player?.rotation ?? new Euler(0, 0, 0, \"XYZ\"),\n      rotationDelta: state.rotationApplied,\n    };\n  };\n\n  const activate = () => {\n    if (objects.player) {\n      objects.player.position.set(0, 0, 0);\n      objects.player.rotation.set(0, 0, 0);\n      console.log(\"actiavting player for navigation\", objects.player?.position);\n    }\n  };\n\n  const deactivate = () => {};\n\n  const unmount = () => {\n    try {\n      //objects.playerRoot.clear();\n    } catch (err) {\n      console.error(`Error while destroy player ${err}`);\n    }\n  };\n\n  return {\n    mount: mount,\n    activate: activate,\n    deactivate: deactivate,\n    update: update,\n    unmount: unmount,\n  };\n};\n"]}