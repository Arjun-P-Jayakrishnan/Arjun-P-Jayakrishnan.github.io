{"version":3,"sources":["../src/engine/managers/RenderManager.ts"],"names":["handleResize","camera","renderer","height","width","handleDebug","e","debugEventBus","scene","createRenderManager","serviceRegistry","getServiceRegistry","logger","threeJsManager","createThreeJsInstance","CANVAS_ID","threeJsContext","gameplay","createGameplayManager","_handleResize","_handleDebug","addEventListeners","removeEventListeners","flattenTask","queueStep"],"mappings":"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","file":"chunk-FLIES6FI.js","sourcesContent":["import { EventBus } from \"@events/eventBus\";\nimport { flattenTask, queueStep } from \"@utils/dsl\";\nimport { CANVAS_ID } from \"config/constants\";\nimport { getServiceRegistry } from \"engine/core/ServiceRegistry\";\nimport { PerspectiveCamera, Scene, WebGLRenderer } from \"three\";\nimport { DebugEvents } from \"types/event.types\";\nimport { Lifecycle, Task } from \"types/lifecycle.types\";\n\nimport {\n  createGameplayManager,\n  GameplayManager,\n} from \"gameplay/GameplayManager\";\nimport { ThreeJsContextManager } from \"./ContextManager\";\nimport { createThreeJsInstance } from \"./ThreeJsManager\";\n\nexport interface RenderManager extends Lifecycle {\n  onInit: () => void;\n}\n\n/** Resises Camera and Renderer on window resise */\nconst handleResize = (camera: PerspectiveCamera, renderer: WebGLRenderer) => {\n  const { height, width } = {\n    height: window.innerHeight,\n    width: window.innerWidth,\n  };\n\n  camera.aspect = width / height;\n  camera.updateProjectionMatrix();\n  renderer.setSize(width, height);\n};\n\n/**Toggles the Object Tree when you press shift and u*/\nconst handleDebug = (\n  e: KeyboardEvent,\n  debugEventBus: EventBus<DebugEvents>,\n  scene: Scene\n) => {\n  if (!(e.key.toLowerCase() === \"u\" && e.shiftKey)) return;\n\n  e.preventDefault();\n  debugEventBus.emit({\n    type: \"debug:inspector\",\n    scene: scene,\n  });\n};\n\nexport const createRenderManager = (): RenderManager => {\n  const serviceRegistry = getServiceRegistry();\n  const logger = serviceRegistry.get(\"Logger\");\n  const threeJsManager = createThreeJsInstance({ domMountId: CANVAS_ID });\n  let threeJsContext: ThreeJsContextManager;\n  const gameplay: GameplayManager = createGameplayManager();\n\n  let _handleResize: (e: UIEvent) => void;\n  let _handleDebug: (e: KeyboardEvent) => void;\n\n  /** Adds required event listeners */\n  const addEventListeners = () => {\n    /**\n     * Primary initialization to ensure correct aspect ratios\n     */\n    handleResize(\n      threeJsContext.get(\"camera\")!,\n      threeJsContext.get(\"renderer\")!\n    );\n\n    window.addEventListener(\"resize\", _handleResize);\n    window.addEventListener(\"keydown\", _handleDebug);\n  };\n\n  /** Release all event listeners to prevent memory leaks */\n  const removeEventListeners = () => {\n    window.removeEventListener(\"resize\", _handleResize);\n    window.removeEventListener(\"keydown\", _handleDebug);\n  };\n\n  const onInit = () => {};\n\n  const onLoad = (): Task[] => {\n    const tasks: Task[] = [\n      ...flattenTask(threeJsManager.onLoad() as Task[]),\n      queueStep(logger.onLoad, { origin: \"Render-Manager\" }),\n    ];\n    return tasks;\n  };\n\n  const onMount = (): Task[] => {\n    const tasks: Task[] = [\n      () => {\n        threeJsContext = serviceRegistry.get(\"ThreeJSContextManager\");\n        //Handle Resize\n        _handleResize = (e: UIEvent) =>\n          handleResize(\n            threeJsContext.get(\"camera\")!,\n            threeJsContext.get(\"renderer\")!\n          );\n        //Handle Debug\n        _handleDebug = (e: KeyboardEvent) =>\n          handleDebug(\n            e,\n            serviceRegistry.get(\"EventBusManager\").debugBus,\n            threeJsContext.get(\"scene\")!\n          );\n      },\n      queueStep(addEventListeners),\n      queueStep(logger.onMount, { origin: \"Render-Manager\" }),\n    ];\n\n    return tasks;\n  };\n\n  const onUpdate = (): Task[] => {\n    return [\n      queueStep(async () => {\n        try {\n          await gameplay.onMount(); // gameplay logic added after obtaining all assets\n        } catch (error) {\n          throw new Error(\"[Game Manager] Loading failed :${error}\");\n        }\n      }),\n      ...flattenTask(threeJsManager.onMount(() => {}) as Task[]), // pass the gameplay loop as callback to the game engine\n      queueStep(threeJsManager.onMount, gameplay.update),\n      queueStep(threeJsManager.onUpdate),\n      queueStep(logger.onUpdate, 0, { origin: \"Render-Manager\" }),\n    ];\n  };\n\n  const onUnmount = () => {\n    const tasks: Task[] = [\n      queueStep(removeEventListeners),\n      queueStep(gameplay.onUnmount),\n      queueStep(threeJsManager.onUnmount),\n      queueStep(logger.onUnmount, { origin: \"Render-Manager\" }),\n    ];\n\n    return tasks;\n  };\n\n  const onDispose = () => {\n    logger.onDestroy({ origin: \"RenderManager\" });\n  };\n\n  return {\n    onInit,\n    onLoad,\n    onMount,\n    onUpdate,\n    onUnmount,\n    onDestroy: onDispose,\n  };\n};\n"]}