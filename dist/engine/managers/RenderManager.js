import {Vector3,Scene,PerspectiveCamera,WebGLRenderer,Clock,LoadingManager,PMREMGenerator,Euler,CatmullRomCurve3,AnimationMixer,DirectionalLight,AmbientLight,PCFShadowMap,Spherical,ShaderMaterial,MathUtils}from'three';import {FBXLoader}from'three/examples/jsm/loaders/FBXLoader.js';import {DRACOLoader}from'three/examples/jsm/loaders/DRACOLoader.js';import {GLTFLoader}from'three/examples/jsm/loaders/GLTFLoader.js';import {RGBELoader}from'three/examples/jsm/loaders/RGBELoader.js';import {OrbitControls}from'three/examples/jsm/controls/OrbitControls.js';function S(t,...a){return ()=>t(...a)}function C(t){let a=[];for(let e of t)Array.isArray(e)?a.push(...C(e)):a.push(e);return a}var D={fov:75,aspectRatio:window.innerWidth/window.innerHeight,near:.1,far:1e3},N="game-engine";var ye=()=>{let t=new Map;return {register:(r,d)=>{if(t.has(r))throw new Error(`Error : Redefining the service [${r}]`);t.set(r,d);},get:r=>{let d=t.get(r);if(!d)throw new Error(`Error : Trying to obtain value of an unregistered service ${r}`);return d},has:r=>t.has(r)}},I,P=()=>(I||(I=ye()),I);var A={PATH_TO_MODELS:"/assets/Models/",PATH_TO_HDR:"/assets/HDR/"},_={id:"player",path:A.PATH_TO_MODELS+"player.glb",type:"glb"},F={meshes:[{id:"navigation",path:A.PATH_TO_MODELS+"room.glb",type:"glb"}],hdr:{id:"environment_hdr",path:A.PATH_TO_HDR+"environment.hdr",type:"hdr"}},j={meshes:[{id:"about",path:A.PATH_TO_MODELS+"about.glb",type:"glb"}]},B={meshes:[{id:"projects",path:A.PATH_TO_MODELS+"projects.glb",type:"glb"}]};var V={player:{id:"RootNode",storageId:"player"},ground:{id:"ground",storageId:"navigation"}},U={player:{id:"RootNode",storageId:"player"},ground:{id:"ground",storageId:"about"}},k={player:{id:"RootNode",storageId:"player"},ground:{id:"ground",storageId:"projects"}};var K=({loadingManager:t,scene:a,storageManager:e})=>{let o=new FBXLoader(t),r=async s=>{try{let i=await o.loadAsync(s.path);e.getStorage("model").store(s.id,{animations:i.animations,groups:i}),a.add(i);}catch(i){throw new Error(`Error while loading fbx file : ${i}`)}};return {load:async s=>{let i=[];s.forEach(n=>{i.push(r(n));}),await Promise.allSettled(i);}}};var W=({scene:t,loadingManager:a,storageManager:e})=>{let o=new GLTFLoader(a),r=new DRACOLoader;r.setDecoderPath("/public/draco/"),o.setDRACOLoader(r);let d=async i=>{try{let n=await o.loadAsync(i.path);e.getStorage("model").store(i.id,{animations:n.animations,groups:n.scene}),t.add(n.scene);}catch(n){throw new Error(`Errr occuerd while loading a glb file : ${n}`)}};return {load:async i=>{let n=[];i.forEach(u=>{n.push(d(u));}),await Promise.allSettled(n);}}};var H=({loadingManager:t,renderer:a,scene:e})=>{let o=new PMREMGenerator(a),r=new RGBELoader(t),d=async n=>new Promise((u,l)=>{console.log("path",n.path),r.load(n.path,(c,m)=>{let h=o.fromEquirectangular(c).texture;c.dispose(),e.environment=h,l();},void 0,c=>{u();});}),s=async n=>{let u=[];n.forEach(async l=>{u.push(d(l));}),await Promise.allSettled(u);};return {load:s}};var J=({scene:t,renderer:a,loaderEventBus:e,stateManager:o,storageManager:r})=>{let d=new LoadingManager,s=false,[i,n,u]=[W({scene:t,loadingManager:d,storageManager:r}),K({scene:t,loadingManager:d,storageManager:r}),H({scene:t,loadingManager:d,renderer:a})],l={glb:[],fbx:[],hdr:[]},c=()=>{d.onStart=(M,f,v)=>{e.emit({type:"load:start",url:M,loaded:f,total:v}),o.loading.setState({loading:{active:true,progress:0}});},d.onProgress=(M,f,v)=>{e.emit({type:"load:progress",url:M,loaded:f,total:v}),o.loading.setState({loading:{active:true,progress:f/v}});},d.onLoad=()=>{e.emit({type:"load:complete"});},d.onError=M=>{e.emit({type:"load:error",url:M});},s=true;},m=M=>{switch(M.type){case "glb":l.glb.push(M);break;case "fbx":l.fbx.push(M);break;case "hdr":l.hdr.push(M);break;}},h=M=>{M.forEach(f=>{m(f);});};return {configure:()=>{c();},load:async M=>{if(!s)throw new Error("Error: Trying to load from loader before configuring it");let f=[];return h(M),f.push(i.load(l.glb)),f.push(n.load(l.fbx)),f.push(u.load(l.hdr)),await Promise.allSettled(f),l.fbx=[],l.glb=[],l.hdr=[],{success:[],error:[]}},dispose:()=>{}}};var $=t=>{let{camera:a}=t,o=new Vector3(0,1,2);return {mount:()=>{},activate:()=>{a.position.set(o.x,1,o.z),a.rotation.set(0,0,0,"XYZ");},deactivate:()=>{},unmount:()=>{}}};var z=({logger:t,reference:a,storage:e})=>{let o=null;return {mount:()=>{if(o=e.getStorage("model").retrieve(a.storageId)?.groups.getObjectByName(a.id),!o){console.error(`Cant get ground mesh from the id : ${a.id}`);return}o.material=o.material.clone(),o.receiveShadow=true,o.material.needsUpdate=true,o.material.opacity=.15,o.material.transparent=true,t.onMount({origin:"about-ground"});},actiavte:()=>{},deactivate:()=>{},unmount:()=>{}}};var X=({renderer:t,scene:a})=>{let e,o;return {mount:()=>{e=new DirectionalLight(16777215,5),e.castShadow=true,e.position.set(0,2,0),e.target.position.set(0,1,0),e.shadow.mapSize.width=1024,e.shadow.mapSize.height=1024,e.shadow.camera.near=.1,e.shadow.camera.far=50,e.shadow.camera.left=-10,e.shadow.camera.right=10,e.shadow.camera.top=10,e.shadow.camera.bottom=-10,o=new AmbientLight(16777215),t.shadowMap.enabled=true,t.shadowMap.type=PCFShadowMap;},activate:()=>{e&&a.add(e),o&&a.add(o);},deactivate:()=>{e&&a.remove(e),o&&a.remove(o);},unmount:()=>{}}};var Y=({logger:t,reference:a,scene:e,storage:o})=>{let r,d,s=c=>{c.traverse(m=>{m.castShadow=true;});};return {mount:()=>{try{t.onMount({origin:"about-room-player"});let c=e.getObjectByName(a.id);if(!c)throw new Error(`player doesn't exist for the id ${a.id}`);r={playerRoot:c},d={mixer:new AnimationMixer(c)};}catch(c){console.error(`Player mesh cant be obtained :${c}`);}},activate:()=>{r.playerRoot&&(r.playerRoot.rotation.set(0,-Math.PI/4,0,"XYZ"),r.playerRoot.castShadow=true,s(r.playerRoot),r.playerRoot.position.set(1.5,0,0));},deactiavte:()=>{},unmount:()=>{r.playerRoot&&r.playerRoot.position.set(1.5,0,0);}}};var q=({ground:t,player:a})=>{let e=P(),[o,r,d]=[e.get("GlobalStorageManager"),e.get("Logger"),e.get("ThreeJSContextManager")],{scene:s,camera:i,orbit:n,renderer:u}={scene:d.get("scene"),camera:d.get("camera"),orbit:d.get("orbit"),renderer:d.get("renderer")},l={camera:$({camera:i}),player:Y({logger:r,reference:a,scene:s,storage:o}),ground:z({logger:r,reference:t,storage:o}),lighting:X({renderer:u,scene:s})},c=null;return {mount:()=>{r.onMount({origin:"about-room"}),l.ground.mount(),l.player.mount(),l.lighting.mount(),c=o.getStorage("model").retrieve(t.storageId)?.groups??null;},setActive:()=>{c&&(c.visible=true),n.enabled=false,l.camera.activate(),l.lighting.activate(),l.player.activate();},update:M=>{},setDeactive:()=>{c&&(c.visible=false),l.lighting.deactivate();},unmount:()=>{l.player.unmount();},isLoaded:false}};var x={DISTANCE:3,HEIGHT_OFFSET:2,PITCH_MIN:0,PITH_MAX:Math.PI/2,SMOOTHING:.1},Q=new Vector3(0,0,0),w=new Vector3(0,0,0),E=new Vector3(0,0,0);function Oe(t,a){return {yaw:MathUtils.euclideanModulo(t,Math.PI*2),pitch:MathUtils.clamp(a,x.PITCH_MIN,x.PITH_MAX)}}function Ge(t){return w.set(0,0,0),w.setFromSpherical(t),w.y+=x.HEIGHT_OFFSET,w}function De(t,a,e){return t.lerp(a,e)}var ee=({camera:t})=>{let e={mode:"thirdPerson",rotation:{pitch:Math.PI/2,yaw:0},spherical:new Spherical(x.DISTANCE,Math.PI/2,0)},o=m=>{e.mode=m;},r=()=>{},d=()=>{t.position.set(1,2,3);},s=m=>{e.rotation.yaw+=m.yaw,e.rotation.pitch+=m.pitch;let h=Oe(e.rotation.yaw,e.rotation.pitch);e.rotation.yaw=h.yaw,e.rotation.pitch=h.pitch;},i=m=>{e.spherical.theta=e.rotation.yaw,e.spherical.phi=e.rotation.pitch,w.copy(Ge(e.spherical)),Q.copy(m.playerPosition).add(w),t.position.copy(De(t.position,Q,x.SMOOTHING)),E.copy(m.playerPosition),E.y+=x.HEIGHT_OFFSET,t.lookAt(E);},n=m=>{t.position.copy(m),t.rotation.set(e.rotation.pitch,e.rotation.yaw,0);};return {setMode:o,update:m=>(s(m.rotationDelta),e.mode==="thirdPerson"?i(m):n(m.playerPosition),{rotation:t.rotation}),mount:r,activate:d,deactivate:()=>{},unmount:()=>{}}};var te=`
    precision highp float;

    varying vec2 vUV;

    float line(vec2 uv,float lineWidth){

       
        float lineAA=fwidth(uv.x);
 
        float lineUV=1.0-abs(fract(uv.x)*2.0-1.0);

        return smoothstep(lineWidth+lineAA,lineWidth-lineAA,lineUV);
    }  

    float grid(vec2 uv,float lineWidth){

        vec2 uvDeriv=fwidth(uv);
        vec2 drawWidth=max(vec2(lineWidth),uvDeriv);
        vec2 lineAA=uvDeriv*1.5;
 
        vec2 gridUV=1.0-abs(fract(uv)*2.0-1.0);

        vec2 gridLines=smoothstep(drawWidth+lineAA,drawWidth-lineAA,gridUV);
        gridLines*=clamp(lineWidth/drawWidth,0.0,1.0);

        return mix(gridLines.x,1.0,gridLines.y);
    } 

    void main(){
        vec2 st=vUV*1500.0;
       
        gl_FragColor = vec4(vec3(grid(st,0.01)),1.0);
    }

`;var oe=`
    precision highp float;

    

    varying vec2 vUV;
    varying vec4 vWorldPos; 

    void main(){
        vUV=uv;
        vWorldPos=modelViewMatrix*vec4(position,1.0);

        gl_Position = projectionMatrix*modelViewMatrix*vec4(position,1.0);
    }

`;var re=t=>{let a=new ShaderMaterial({uniforms:{time:{value:1},cameraPos:{value:t.camera.position},fadeNear:{value:t.fadeNear},fadeFar:{value:t.fadeFar}},vertexShader:oe,fragmentShader:te});return {mat:a,update:o=>{a.uniforms.cameraPos.value=o;}}};var ae=({logger:t,references:a,storage:e,camera:o})=>{let r=null,d=null;return {mount:()=>{if(r=e.getStorage("model").retrieve(a.storageId)?.groups.getObjectByName(a.id)??null,!r){console.error(`Cant get ground mesh from the id : ${a.id} ${a.storageId}`);return}d=re({camera:o,fadeNear:.1,fadeFar:1}),r.material=d.mat,t.onMount({origin:"Navigation-Ground"});},update:()=>{d?.update(o.position);},activate:()=>{},deactivate:()=>{},unmount:()=>{}}};var ne=({mixer:t,actions:a,crossFadeDuration:e=.3})=>{let o=null,d=null;return {play:(l,c=0)=>{if(o===l)return;let m=a[l];m&&(m.reset(),m.play(),d?.crossFadeTo(m,e,false),d=m,o=l);},getCurrentAnimation:()=>o,stop:()=>{},update:l=>{l!==void 0&&t.update(l);}}};var _e=t=>({enter:r=>{console.log("enter idle"),t.animationController.play(t.animationId);},execute:r=>{r.isMoving()&&(r.isShiftPressed()?r.changeState("Run"):r.changeState("Walk"));},exit:r=>{console.log("exit idle");}}),Fe=t=>({enter:r=>{console.log("enter walk"),t.animationController.play(t.animationId);},execute:r=>{r.isMoving()?r.isShiftPressed()&&r.changeState("Run"):r.changeState("Idle");},exit:r=>{console.log("exit walk");}}),je=t=>({enter:r=>{console.log("enter run"),t.animationController.play(t.animationId);},execute:r=>{r.isMoving()?r.isShiftPressed()||r.changeState("Walk"):r.changeState("Idle");},exit:r=>{console.log("exit run");}}),ie=({inputs:t,animationController:a})=>{let {keyboard:o}={mouse:t.getController("mouse"),keyboard:t.getController("keyboard")},{idle:d,walk:s,run:i}={idle:_e({animationController:a,animationId:"Idle"}),walk:Fe({animationController:a,animationId:"Walk"}),run:je({animationController:a,animationId:"Run"})},n=d,u="Idle",l=f=>{n.execute(y),a.update(f);},c=()=>!!(o?.isKeyPressed("w")||o?.isKeyPressed("a")||o?.isKeyPressed("s")||o?.isKeyPressed("d")),m=()=>o?.isKeyPressed("shift")??false,h=f=>{switch(f){case "Idle":return d;case "Walk":return s;case "Run":return i;default:return d}},b=f=>{u!==f&&(u=f,n.exit(y),n=h(f),n.enter(y));},p=()=>{n.enter(y);},y={changeState:b,isMoving:c,isShiftPressed:m};return {mount:p,update:l,unmount:()=>{}}};var se={MOVEMENT_ACCELERATION:.05,MAX_VELOCITY:.05},ce=({reference:t,storage:a,InputManager:e})=>{let o,r={direction:new Vector3(0,0,-1),velocity:new Vector3(0,0,0),rotationApplied:{pitch:0,yaw:0}},d={inputDirection:new Vector3(0,0,0)},s={player:null},i=()=>{try{let p=a.getStorage("model").retrieve(t.storageId);if(!p)throw new Error(`player doesn't exist for the id ${t.storageId}`);let y=p?.groups,M=p?.animations,f=new AnimationMixer(y),v=ne({mixer:f,actions:{Idle:f.clipAction(M[0]),Walk:f.clipAction(M[3]),Run:f.clipAction(M[1])},crossFadeDuration:.3}),g=ie({animationController:v,inputs:e});g.mount(),s={player:y},o={input:{mouse:e.getController("mouse"),keyboard:e.getController("keyboard")},animation:v,fsm:g};}catch(p){console.error(`Player mesh cant be obtained :${p}`);}},n=p=>{!p||!s.player||(r.rotationApplied=p.getRotation(),s.player.rotation.y+=r.rotationApplied.yaw);},u=(p,y)=>{if(!p||!s.player)return;let f=.001,{inputDirection:v}=d;if(v.set(0,0,0),p.isKeyPressed("w")&&(v.z-=1),p.isKeyPressed("s")&&(v.z+=1),p.isKeyPressed("a")&&(v.x-=1),p.isKeyPressed("d")&&(v.x+=1),v.length()>0)v.applyQuaternion(s.player.quaternion),v.normalize(),r.velocity.add(v.multiplyScalar(se.MOVEMENT_ACCELERATION*y)),r.velocity.clampLength(0,se.MAX_VELOCITY);else if(v.length()==0&&r.velocity.length()>0){let g=Math.exp(-5*y);r.velocity.multiplyScalar(g),r.velocity.lengthSq()<f*f&&r.velocity.set(0,0,0);}s.player.position.add(r.velocity);},l=p=>{n(o.input.mouse),u(o.input.keyboard,p);};return {mount:i,activate:()=>{},deactivate:()=>{},update:p=>(l(p),o.fsm.update(p),{position:s.player?.position??new Vector3(0,0,0),rotation:s.player?.rotation??new Euler(0,0,0,"XYZ"),rotationDelta:r.rotationApplied}),unmount:()=>{}}};var le=({player:t,ground:a})=>{let e=P(),[o,r,d,s,i]=[e.get("Logger"),e.get("GlobalStorageManager"),e.get("EventBusManager"),e.get("InputManager"),e.get("ThreeJSContextManager")],n={camera:ee({camera:i.get("camera")}),player:ce({reference:t,InputManager:s,storage:r}),ground:ae({camera:i.get("camera"),logger:o,references:a,storage:r})},u=null,c=null,m=false;return {mount:()=>{m||!n||(o.onMount({origin:"Navigation Room"}),u={player:{position:new Vector3(0,0,0),rotation:new Euler(0,0,0),rotationDelta:{yaw:0,pitch:0}}},c=r.getStorage("model").retrieve(a.storageId)??null,n.player.mount(),n.ground.mount(),n.camera.mount(),m=true);},update:f=>{!m||!n||!u||(i.get("orbit").update(),u.player=n.player.update(f),n.camera.update({playerPosition:u.player.position,rotationDelta:u.player.rotationDelta}));},unmount:()=>{!m||!n||(o.onUnmount({origin:"Navigation Room"}),n.player.unmount(),n.ground.unmount(),n=null,c=null);},setActive:()=>{!c||!n||(c.groups.visible=true,i.get("orbit").enabled=false,n.camera.activate(),n.ground.activate(),n.player.activate());},setDeactive:()=>{!c||!n||(c.groups.visible=false,n.camera.deactivate(),n.ground.deactivate(),n.player.deactivate());},isLoaded:false}};var de=({camera:t,eventBusManager:a,orbit:e,scene:o})=>{let r=[new Vector3(0,2,10),new Vector3(0,2,5),new Vector3(0,2,3),new Vector3(0,2,2),new Vector3(0,2,1),new Vector3(0,2,0),new Vector3(0,2,-1),new Vector3(0,1,-1),new Vector3(0,1,-1.5),new Vector3(0,1,-2)],d=new CatmullRomCurve3(r),s=0,i=false;return {mount:()=>{s=0;},activate:()=>{e.enabled=false,t.position.set(0,2.5,10),t.near=.001,t.far=1e3;},update:h=>{if(!i&&s>1&&(i=true,e.enabled=true,a.viewBus.emit({type:"project-screen:show",elementId:"project-screen"}),console.log("event emitted view event")),!i&&(s+=h*.1,s<=.9)){let b=d.getPointAt(s),p=d.getPointAt(s+.1);p.z-=.1,t.position.copy(b),t.lookAt(p);}},deactivate:()=>{},unmount:()=>{}}};var me=({reference:t,logger:a,storage:e})=>{let o=null;return {mount:()=>{let n=e.getStorage("model").retrieve(t.storageId)?.groups;if(o=n?.getObjectByName(t.id),!o){console.error(`Cant get ground mesh from the id : ${t.id}`);return}o.material=o.material.clone(),o.receiveShadow=true,o.material.needsUpdate=true,o.material.opacity=1,o.material.transparent=true;let u=["sky","ground"];n?.traverse(l=>{u.includes(l.name)||(l.castShadow=true);}),a.onMount({origin:"about-ground"});},actiavte:()=>{},deactivate:()=>{},unmount:()=>{}}};var ue=({renderer:t,scene:a})=>{let e,o;return {mount:()=>{e=new DirectionalLight(16777215,5),e.castShadow=true,e.position.set(0,1,.5),e.target.position.set(0,0,0),e.shadow.mapSize.width=1024,e.shadow.mapSize.height=1024,e.shadow.camera.near=.1,e.shadow.camera.far=50,e.shadow.camera.left=-10,e.shadow.camera.right=10,e.shadow.camera.top=10,e.shadow.camera.bottom=-10,o=new AmbientLight(16777215),t.shadowMap.enabled=true,t.shadowMap.type=PCFShadowMap;},activate:()=>{e&&a.add(e),o&&a.add(o);},deactivate:()=>{e&&a.remove(e),o&&a.remove(o);},unmount:()=>{}}};var pe=({logger:t,reference:a,storage:e})=>{let o,r=[],d=c=>{c.traverse(m=>{m.castShadow=true;});};return {mount:()=>{try{let c=e.getStorage("model").retrieve(a.storageId)?.groups,m=e.getStorage("model").retrieve(a.storageId)?.animations??[];if(!c)throw new Error(`player doesn't exist for the id ${a.storageId}`);o={playerRoot:c};let h=new AnimationMixer(c);h.clipAction(m[2]).play(),r.push(h),t.onMount({origin:"Project-Room-Player"});}catch(c){console.error(`Player mesh cant be obtained :${c}`);}},activate:()=>{o.playerRoot&&(o.playerRoot.rotation.set(0,0,0,"XYZ"),o.playerRoot.castShadow=true,d(o.playerRoot));},update:c=>{r.forEach(m=>{m.update(c);});},deactiavte:()=>{},unmount:()=>{}}};var ge=({player:t,ground:a})=>{let e=P(),[o,r,d,s]=[e.get("GlobalStorageManager"),e.get("ThreeJSContextManager"),e.get("EventBusManager"),e.get("Logger")],{scene:i,camera:n,orbit:u,renderer:l}={scene:r.get("scene"),camera:r.get("camera"),orbit:r.get("orbit"),renderer:r.get("renderer")},c={camera:de({camera:n,eventBusManager:d,orbit:u,scene:i}),player:pe({logger:s,reference:t,storage:o}),ground:me({logger:s,reference:a,storage:o}),lighting:ue({renderer:l,scene:i})},m=null;return {mount:()=>{c.ground.mount(),c.player.mount(),c.camera.mount(),c.lighting.mount(),m=o.getStorage("model").retrieve(a.storageId)?.groups??null,s.onMount({origin:"Projects"});},setActive:()=>{m&&(m.visible=true),c.camera.activate(),c.lighting.activate(),c.player.activate();},update:f=>{c.player.update(f),c.camera.update(f);},setDeactive:()=>{m&&(m.visible=false),c.lighting.deactivate();},unmount:()=>{},isLoaded:false}};var fe=()=>{let t=P(),[a,e,o,r,d]=[t.get("GlobalStorageManager"),t.get("Logger"),t.get("EventBusManager"),t.get("ThreeJSContextManager"),t.get("GlobalStateManager")],s=null,i={navigation:null,about:null,projects:null},n={navigation:F,about:j,projects:B},u=null,l=null,c=()=>{try{s=J({storageManager:a,stateManager:d,loaderEventBus:o.loadingBus,renderer:r.get("renderer"),scene:r.get("scene")}),s?.configure();}catch(g){throw new Error(`[Gameplay] Couldnt create and initailize the loader due to ${g}`)}},m=g=>{switch(g){case "navigation":return i[g]=le(V),i[g];case "about":return i[g]=q(U),i[g];case "projects":return i[g]=ge(k),i[g];default:throw new Error(`Unknown Room key ${g}`)}},h=async g=>{if(!s)return;if(!n[g])throw new Error("[Room Controller] sufficient asset meta data is not given.");if(!i[g]){let L=m(g);console.log("load room",n[g]);let G=[...n[g].meshes];n[g].hdr&&G.push(n[g].hdr),await s.load(G),L&&(L.mount(),L.isLoaded=true,u=L);}},b=async g=>{l!==g&&(l!=null&&i[l]!=null&&i[l].setDeactive(),await h(g),i[g]&&i[g].setActive(),l=g);},p=async()=>{e.onMount({origin:"Room Controller"}),c(),await s?.load([_]),await h("navigation"),await b("navigation");},y=g=>{u?.update(g);},M=()=>{s?.dispose(),Object.values(i).forEach(g=>{g?.unmount();}),e.onUnmount({origin:"room-controller"});},f=g=>{o.loadingBus.emit({type:"load:start",loaded:0,total:0,url:""}),Promise.allSettled([b(g)]).then(()=>{o.loadingBus.emit({type:"load:complete"});});},v=()=>{l&&u?.setDeactive();};return {mount:p,switchRoom:{navigation:()=>f("navigation"),about:()=>f("about"),projects:()=>f("projects"),default:()=>v()},update:y,unmount:M}};var ve=()=>{let t=P(),[a,e,o]=[t.get("EventBusManager"),t.get("Logger"),t.get("InputManager")],r=new Clock,d={deltaTime:0},s={deltaTime:0},i=false,n=fe(),u=()=>{a.displayBus.on("about:show",n.switchRoom.about),a.displayBus.on("about:hide",n.switchRoom.default),a.displayBus.on("projects:show",n.switchRoom.projects),a.displayBus.on("projects:hide",n.switchRoom.default),a.displayBus.on("home:show",n.switchRoom.navigation),a.displayBus.on("home:hide",n.switchRoom.default);},l=async()=>{i||(await n.mount(),u(),i=true,window.addEventListener("keyup",p=>{console.log(p);}));},c=()=>{s.deltaTime=r.getDelta(),!isNaN(s.deltaTime)&&s.deltaTime!==void 0&&(d.deltaTime=s.deltaTime);},m=()=>{c(),n.update(d.deltaTime??0);};return {onMount:l,update:m,onUnmount:()=>{}}};var Me=t=>{let{fov:a,aspectRatio:e,near:o,far:r}=D,d=new Scene,s=new PerspectiveCamera(a,e,o,r),i=new WebGLRenderer({antialias:true}),n,u=null,l=null,c=P().get("ThreeJSContextManager"),m=P().get("Logger"),h=v=>{let g=document.getElementById(v);i.setSize(window.innerWidth,window.innerHeight),i.setPixelRatio(window.devicePixelRatio),g?(g.appendChild(i.domElement),n=new OrbitControls(s,i.domElement)):console.warn(`Could not find element with selector tag : ${v}`);},b=()=>{c.set("scene",d),c.set("camera",s),c.set("orbit",n),c.set("renderer",i);};return {onLoad:()=>[S(h,t.domMountId),S(b),S(m.onLoad,{origin:"ThreeJs-Manager"})],onMount:v=>[()=>{u=v;},S(m.onMount,{origin:"ThreeJs-Manager"})],onUpdate:()=>{if(l!==null)return;let v=()=>{l=requestAnimationFrame(v),u?.(),i.render(d,s);};v();},onUnmount:()=>{let v=document.getElementById(t.domMountId);l!==null&&(cancelAnimationFrame(l),l=0),v&&i.domElement.parentElement===v&&v.removeChild(i.domElement),i.dispose(),m.onUnmount({origin:"ThreeJs-Manager"});},onDestroy:()=>{}}};var he=(t,a)=>{let{height:e,width:o}={height:window.innerHeight,width:window.innerWidth};t.aspect=o/e,t.updateProjectionMatrix(),a.setSize(o,e);},Qe=(t,a,e)=>{t.key.toLowerCase()==="u"&&t.shiftKey&&(t.preventDefault(),a.emit({type:"debug:inspector",scene:e}));},Ar=()=>{let t=P(),a=t.get("Logger"),e=Me({domMountId:N}),o,r=ve(),d,s,i=()=>{he(o.get("camera"),o.get("renderer")),window.addEventListener("resize",d),window.addEventListener("keydown",s);},n=()=>{window.removeEventListener("resize",d),window.removeEventListener("keydown",s);};return {onInit:()=>{},onLoad:()=>[...C(e.onLoad()),S(a.onLoad,{origin:"Render-Manager"})],onMount:()=>[()=>{o=t.get("ThreeJSContextManager"),d=y=>he(o.get("camera"),o.get("renderer")),s=y=>Qe(y,t.get("EventBusManager").debugBus,o.get("scene"));},S(i),S(a.onMount,{origin:"Render-Manager"})],onUpdate:()=>[S(async()=>{try{await r.onMount();}catch{throw new Error("[Game Manager] Loading failed :${error}")}}),...C(e.onMount(()=>{})),S(e.onMount,r.update),S(e.onUpdate),S(a.onUpdate,0,{origin:"Render-Manager"})],onUnmount:()=>[S(n),S(r.onUnmount),S(e.onUnmount),S(a.onUnmount,{origin:"Render-Manager"})],onDestroy:()=>{a.onDestroy({origin:"RenderManager"});}}};export{Ar as createRenderManager};//# sourceMappingURL=RenderManager.js.map
//# sourceMappingURL=RenderManager.js.map