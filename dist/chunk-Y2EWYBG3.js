import {a as a$3}from'./chunk-WNPVTV3D.js';import {a}from'./chunk-Y3P3ES6H.js';import {a as a$2}from'./chunk-CRGVJHEO.js';import {c}from'./chunk-TO4VY5TN.js';import {b}from'./chunk-Q74ELE7M.js';import {a as a$1}from'./chunk-JHTWF4VD.js';import {Vector3,Clock,Euler,AnimationMixer}from'three';var K=()=>{let s=new Set,n=a=>a.toLowerCase(),l=a=>{s.delete(n(a.key));},t=a=>{s.add(n(a.key));};return {mount:()=>{window.addEventListener("keyup",l),window.addEventListener("keydown",t);},unmount:()=>{window.removeEventListener("keyup",l),window.removeEventListener("keydown",t),s.clear();},getPressedKeys:()=>Array.from(s),isKeyPressed:a=>s.has(n(a))}};var I=s=>{let n={mouse:{lastX:0,lastY:0},rotation:{pitch:0,yaw:0}},l=e=>{n.rotation.pitch=e.clientY-n.mouse.lastY,n.rotation.yaw=e.clientX-n.mouse.lastX,n.mouse.lastX=e.clientX,n.mouse.lastY=e.clientY;};return {mount:()=>{document.addEventListener("mousemove",l);},unmount:()=>{document.removeEventListener("mousemove",l);},getRotation:()=>{let e=n.rotation.yaw,o=n.rotation.pitch;return n.rotation.pitch=0,n.rotation.yaw=0,{yaw:s.sensitivity*e,pitch:s.sensitivity*o}}}};var g=null,M=()=>({mount:t=>{g||(g={mouse:I(t.mouse),keyboard:K()},g.mouse.mount(),g.keyboard.mount());},getController:t=>g?g[t]:null,unmount:()=>{g&&(g.mouse.unmount(),g.keyboard.unmount());}});var E={THIRD_PERSON:{OFFSET:new Vector3(0,5,-10),DISTANCE:10,HEIGHT_OFFSET:3,PITCH:{MIN:0,MAX:Math.PI/3},SMOOTHING:.1},FIRST_PERSON:{OFFSET:new Vector3(0,0,0)}},R={position:new Vector3(0,0,0),offset:new Vector3(0,0,0),lookTarget:new Vector3(0,0,0)},A=s=>{let {camera:n}=s,t={pitch:0,yaw:0},u=R.offset,i=R.position,e=R.lookTarget,o=E.THIRD_PERSON.DISTANCE,a=(c,f)=>{t.yaw+=c,t.pitch+=f,t.pitch=Math.max(E.THIRD_PERSON.PITCH.MIN,Math.min(t.pitch,E.THIRD_PERSON.PITCH.MAX));};return {update:(c,f)=>{{let{yaw:b,pitch:C}=f;return a(b,C),u.x=o*Math.sin(t.yaw)*Math.cos(t.pitch),u.y=o*Math.sin(t.pitch)+E.THIRD_PERSON.HEIGHT_OFFSET,u.z=o*Math.cos(t.yaw)*Math.cos(t.pitch),i.copy(c).add(u),n.position.lerp(R.position,E.THIRD_PERSON.SMOOTHING),e.copy(c),e.y+=E.THIRD_PERSON.HEIGHT_OFFSET,n.lookAt(e),{rotation:n.rotation}}}}};var N=s=>{let n=null,l=a$1(),t=null;return {mount:()=>{if(n=l.getProperty("scene").getObjectByName(s.ids.groundRoot),!n){console.error(`Cant get ground mesh from the id : ${s.ids.groundRoot}`);return}t=a$3({camera:l.getProperty("camera"),fadeNear:.1,fadeFar:1}),n.material=t.mat;},update:()=>{t?.update(l.getProperty("camera").position);},unmount:()=>{}}};var L={MOVEMENT_ACCELERATION:.05,MAX_VELOCITY:.05},_=s=>{let{eventBusManager:n,globalState:l,globalStorage:t}=b(),u=a$1(),i={direction:new Vector3(0,0,-1),velocity:new Vector3(0,0,0),rotationApplied:{yaw:0}},e={inputDirection:new Vector3(0,0,0)},o={mouse:null,keyboard:null},a,p,c=()=>{try{let r=u.getProperty("scene").getObjectByName(s.ids.rootMesh);if(!r)throw new Error(`player doesn't exist for the id ${s.ids.rootMesh}`);a={playerRoot:r},p={mixer:new AnimationMixer(r)},o={mouse:M().getController("mouse"),keyboard:M().getController("keyboard")};}catch(r){console.error(`Player mesh cant be obtained :${r}`);}},f=(r,y)=>{i.rotationApplied=r,a.playerRoot.rotation.y+=i.rotationApplied.yaw;},b$1=r=>{if(!o.keyboard)return;let P=.001,{inputDirection:d}=e;if(d.set(0,0,0),o.keyboard.isKeyPressed("w")&&(d.z-=1),o.keyboard.isKeyPressed("s")&&(d.z+=1),o.keyboard.isKeyPressed("a")&&(d.x-=1),o.keyboard.isKeyPressed("d")&&(d.x+=1),d.length()>0)d.applyQuaternion(a.playerRoot.quaternion),d.normalize(),i.velocity.add(d.multiplyScalar(L.MOVEMENT_ACCELERATION*r)),i.velocity.clampLength(0,L.MAX_VELOCITY);else if(d.length()==0&&i.velocity.length()>0){let V=Math.exp(-5*r);i.velocity.multiplyScalar(V),i.velocity.lengthSq()<P*P&&i.velocity.set(0,0,0);}a.playerRoot.position.add(i.velocity);},C=(r,y,P)=>{f(y),b$1(r);},h=r=>{p.mixer.update(r);};return {create:c,update:(r,y,P)=>(p.mixer&&h(r),C(r,y),{position:a.playerRoot.position,rotation:a.playerRoot.rotation}),destroy:()=>{try{a.playerRoot.clear();}catch(r){console.error(`Error while destroy player ${r}`);}}}};var H=s=>{let{globalState:n,eventBusManager:l,globalStorage:t}=b(),u=new Clock,i,e,o={deltaTime:0,mouseRotation:{yaw:0,pitch:0},camera:{rotation:new Euler(0,0,0,"XYZ")}},a={deltaTime:0,playerData:null},p=()=>{i=a$1();let C=M();C.mount({mouse:{sensitivity:.01}});let h=_({ids:s.player.ids});h.create();let T=A({camera:i.getProperty("camera")}),x=N(s.ground);x.mount(),e={player:h,camera:T,ground:x,controllers:C};},c=()=>{a.deltaTime=u.getDelta(),isNaN(a.deltaTime)||(o.deltaTime=a.deltaTime);};return {mount:p,update:()=>{c(),o.mouseRotation=e.controllers.getController("mouse")?.getRotation(),a.playerData=e.player.update(o.deltaTime,o.mouseRotation,o.camera),o.camera=e.camera.update(a.playerData.position,o.mouseRotation),e.ground.update();},unmount:()=>{e.player.destroy(),e.controllers.unmount(),e.ground.unmount(),i.unmount(),e=null,i=null;}}};var Le=s=>{let{globalState:n,eventBusManager:l}=b(),t={isMounted:false},u=a({camera:{},domMountTag:"game-engine"}),i=H(c),e=null,o=null,a$3=()=>{if(!e)return;let r=window.innerWidth,y=window.innerHeight;e.camera.aspect=r/y,e.camera.updateProjectionMatrix(),e.renderer.setSize(r,y);},p=r=>{e&&r.key.toLowerCase()==="u"&&r.shiftKey&&(r.preventDefault(),l.debugBus.emit({type:"debug:inspector",scene:e.scene}));},c$1=()=>{a$3(),window.addEventListener("resize",a$3),window.addEventListener("keydown",p);},f=()=>{e={scene:a$1().getProperty("scene"),camera:a$1().getProperty("camera"),renderer:a$1().getProperty("renderer"),orbit:a$1().getProperty("orbit")},o=a$2(s.loaderOptions,{globalState:n,loaderEventBus:l.loadingBus,renderer:e.renderer,scene:e.scene});},b$1=()=>{t.isMounted||(u.mount(),f(),c$1(),o.configure(),t.isMounted=true);},C=()=>{u.render();},h=()=>{t.isMounted&&(window.removeEventListener("resize",a$3),window.removeEventListener("keydown",p),i&&i.unmount(),u.dispose(),o&&(o.dispose(),o=null),e=null,t.isMounted=false);},T=()=>{i.mount(),u.register(i.update);};return {mount:b$1,unmount:h,update:C,load:async()=>{try{if(!t.isMounted)throw new Error("Try to load before mounting");await o.loadAll(),T();}catch(r){console.error(`Error while loading :${r}`);}}}};export{Le as a};//# sourceMappingURL=chunk-Y2EWYBG3.js.map
//# sourceMappingURL=chunk-Y2EWYBG3.js.map