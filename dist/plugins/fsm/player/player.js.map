{"version":3,"sources":["../../../../src/plugins/fsm/player/player.ts"],"names":["createPlayer","reference","storage","InputManager","controllers","movementController","objects","registry","getServiceRegistry","animationOrchestrator","animationParams","animationEntityId","lastRotationDelta","playerRoot","player","animationEntity","createPlayerAnimationEntity","createPlayerMovementController","Vector3","deltaTime","Euler","frame"],"mappings":"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","file":"player.js","sourcesContent":["import { getServiceRegistry } from \"engine/core/ServiceRegistry\";\nimport { AnimationOrchestrator } from \"engine/managers/animation/AnimationManager\";\nimport { InputManager } from \"engine/managers/InputManager\";\nimport { GlobalStorageManager } from \"engine/managers/storage/storageTypes\";\nimport {\n  PlayerMovementController,\n  createPlayerMovementController,\n} from \"gameplay/player/playerMovementController\";\nimport { KeyboardInput } from \"plugins/input/keyboard\";\nimport { MouseInput } from \"plugins/input/mouse\";\nimport { Euler, Object3D, Vector3 } from \"three\";\nimport { Nullable } from \"types/generic.types\";\nimport { GenericLifeCycle, ModelIdentifier } from \"types/rooms.types\";\nimport { ServiceRegistry } from \"types/service.types\";\nimport { createPlayerAnimationEntity } from \"./playerAnimationEntity\";\n\n/* -------------------------------------------------------------------------- */\n/*                                Public Types                                */\n/* -------------------------------------------------------------------------- */\n\nexport interface PlayerProps {\n  reference: ModelIdentifier;\n  storage: GlobalStorageManager;\n  InputManager: InputManager;\n}\n\nexport interface Player extends GenericLifeCycle {\n  update: (deltaTime: number) => {\n    position: Vector3;\n    rotation: Euler;\n    rotationDelta: { yaw: number; pitch: number };\n  };\n}\n\n/* -------------------------------------------------------------------------- */\n/*                               Internal Types                                */\n/* -------------------------------------------------------------------------- */\n\ninterface Controllers {\n  input: {\n    mouse: Nullable<MouseInput>;\n    keyboard: Nullable<KeyboardInput>;\n  };\n}\n\ninterface ObjectReferences {\n  player: Nullable<Object3D>;\n}\n\n/* -------------------------------------------------------------------------- */\n/*                               Factory Method                                */\n/* -------------------------------------------------------------------------- */\n\nexport const createPlayer = ({\n  reference,\n  storage,\n  InputManager,\n}: PlayerProps): Player => {\n  /* ----------------------------- Local State ------------------------------ */\n\n  let controllers: Controllers;\n  let movementController: PlayerMovementController;\n\n  const objects: ObjectReferences = { player: null };\n\n  const registry: ServiceRegistry = getServiceRegistry();\n\n  let animationOrchestrator: AnimationOrchestrator;\n  let animationParams: ReturnType<typeof createPlayerAnimationEntity>[\"params\"];\n\n  const animationEntityId = `player-${reference.storageId}`;\n\n  let lastRotationDelta = { yaw: 0, pitch: 0 };\n\n  /* ------------------------------------------------------------------------ */\n  /*                                   Mount                                  */\n  /* ------------------------------------------------------------------------ */\n\n  const mount = () => {\n    const playerRoot = storage\n      .getStorage(\"model\")\n      .retrieve(reference.storageId);\n\n    if (!playerRoot) {\n      throw new Error(`Player model not found for id ${reference.storageId}`);\n    }\n\n    objects.player = playerRoot.groups;\n    const player = playerRoot.groups;\n\n    /* -------------------------- Animation Setup --------------------------- */\n\n    animationOrchestrator = registry.get(\"AnimationManager\");\n\n    const animationEntity = createPlayerAnimationEntity({\n      id: animationEntityId,\n      playerObject: player,\n      animations: playerRoot.animations,\n    });\n\n    animationEntity.playback.onMount();\n    animationEntity.playback.play(\"Idle\");\n\n    animationParams = animationEntity.params;\n    animationOrchestrator.addEntity(animationEntity);\n\n    /* ----------------------------- Input ---------------------------------- */\n\n    controllers = {\n      input: {\n        mouse: InputManager.getController(\"mouse\"),\n        keyboard: InputManager.getController(\"keyboard\"),\n      },\n    };\n\n    /* ----------------------- Movement Controller -------------------------- */\n\n    movementController = createPlayerMovementController({\n      object: objects.player,\n      keyboard: controllers.input.keyboard,\n      mouse: controllers.input.mouse,\n    });\n\n    movementController.initialize(new Vector3(0, 0, -1));\n  };\n\n  /* ------------------------------------------------------------------------ */\n  /*                                   Update                                 */\n  /* ------------------------------------------------------------------------ */\n\n  const update = (deltaTime: number) => {\n    if (!movementController || !objects.player) {\n      return {\n        position: new Vector3(),\n        rotation: new Euler(),\n        rotationDelta: { yaw: 0, pitch: 0 },\n      };\n    }\n\n    const frame = movementController.update(deltaTime);\n\n    /* --------------------------- Animation Params -------------------------- */\n\n    animationParams.set(\"speed\", frame.speed);\n    animationParams.set(\"isMoving\", frame.isMoving);\n    animationParams.set(\"isRunning\", frame.isRunning);\n\n    lastRotationDelta.yaw = frame.yawDelta;\n\n    return {\n      position: objects.player.position,\n      rotation: objects.player.rotation,\n      rotationDelta: lastRotationDelta,\n    };\n  };\n\n  /* ------------------------------------------------------------------------ */\n  /*                             Lifecycle Hooks                               */\n  /* ------------------------------------------------------------------------ */\n\n  const activate = () => {\n    if (!objects.player) return;\n\n    objects.player.position.set(0, 0, 0);\n    objects.player.rotation.set(0, 0, 0);\n  };\n\n  const deactivate = () => {};\n\n  const unmount = () => {\n    animationOrchestrator?.removeEntity(animationEntityId);\n  };\n\n  /* ------------------------------------------------------------------------ */\n\n  return {\n    mount,\n    activate,\n    deactivate,\n    update,\n    unmount,\n  };\n};\n"]}