{"version":3,"sources":["../src/gameplay/RoomManager.ts"],"names":["createRoomController","serviceRegistry","getServiceRegistry","storage","logger","eventBusManager","contextManager","stateManager","animationManager","inputsManager","loader","rooms","roomAssets","NAVIGATION_ROOM_ASSETS","ABOUT_ROOM_ASSETS","PROJECTS_ROOM_ASSETS","activeRoom","activeRoomKey","initializeLoader","createLoader","err","instantiateRoom","key","createNavigationRoom","NAVIGATION_ROOM_OPTIONS","createAboutRoom","ABOUT_ROOM_OPTIONS","createProjectRoom","PROJECTS_ROOM_OPTIONS","loadRoom","room","loadItems","switchRoom","_loadPlayer","PLAYER_ASSET","mount","update","deltaTime","unmount","transitionRooms","deactivateRoom"],"mappings":"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","file":"chunk-ILOFW6BN.js","sourcesContent":["import {\n  ABOUT_ROOM_ASSETS,\n  NAVIGATION_ROOM_ASSETS,\n  PLAYER_ASSET,\n  PROJECTS_ROOM_ASSETS,\n} from \"config/asset_manifest\";\nimport {\n  ABOUT_ROOM_OPTIONS,\n  NAVIGATION_ROOM_OPTIONS,\n  PROJECTS_ROOM_OPTIONS,\n} from \"config/rooms\";\nimport { createLoader, Loader } from \"engine/core/LoadingManager\";\nimport { getServiceRegistry } from \"engine/core/ServiceRegistry\";\nimport { createAboutRoom } from \"gameplay/rooms/about/room\";\nimport { createNavigationRoom } from \"gameplay/rooms/navigation/room\";\nimport { createProjectRoom } from \"gameplay/rooms/projects/room\";\nimport { Nullable } from \"types/generic.types\";\nimport { Room, RoomAsset } from \"types/rooms.types\";\n\nexport interface RoomController {\n  mount: () => Promise<void>;\n  switchRoom: Record<RoomKey | \"default\", () => void>;\n  update: (deltaTime: number) => void;\n  unmount: () => void;\n}\n\ntype RoomKey = \"navigation\" | \"about\" | \"projects\";\n\ntype RoomMap = {\n  [key in RoomKey]: Nullable<Room>;\n};\n\ntype RoomAssetsMap = {\n  [key in RoomKey]: RoomAsset;\n};\n\nexport const createRoomController = (): RoomController => {\n  const serviceRegistry = getServiceRegistry();\n  const [\n    storage,\n    logger,\n    eventBusManager,\n    contextManager,\n    stateManager,\n    animationManager,\n    inputsManager,\n  ] = [\n    serviceRegistry.get(\"GlobalStorageManager\"),\n    serviceRegistry.get(\"Logger\"),\n    serviceRegistry.get(\"EventBusManager\"),\n    serviceRegistry.get(\"ThreeJSContextManager\"),\n    serviceRegistry.get(\"GlobalStateManager\"),\n    serviceRegistry.get(\"AnimationManager\"),\n    serviceRegistry.get(\"InputManager\"),\n  ];\n\n  let loader: Nullable<Loader> = null;\n  let rooms: RoomMap = { navigation: null, about: null, projects: null };\n  let roomAssets: RoomAssetsMap = {\n    navigation: NAVIGATION_ROOM_ASSETS,\n    about: ABOUT_ROOM_ASSETS,\n    projects: PROJECTS_ROOM_ASSETS,\n  };\n  let activeRoom: Nullable<Room> = null;\n  let activeRoomKey: Nullable<RoomKey> = null;\n\n  const initializeLoader = (): void => {\n    try {\n      loader = createLoader({\n        storageManager: storage,\n        stateManager: stateManager,\n        loaderEventBus: eventBusManager.loadingBus,\n        renderer: contextManager.get(\"renderer\")!,\n        scene: contextManager.get(\"scene\")!,\n      });\n      loader?.configure();\n    } catch (err) {\n      throw new Error(\n        `[Gameplay] Couldnt create and initailize the loader due to ${err}`\n      );\n    }\n  };\n\n  const instantiateRoom = (key: RoomKey): Room => {\n    switch (key) {\n      case \"navigation\":\n        rooms[key] = createNavigationRoom(NAVIGATION_ROOM_OPTIONS);\n        return rooms[key]!;\n      case \"about\":\n        rooms[key] = createAboutRoom(ABOUT_ROOM_OPTIONS);\n        return rooms[key]!;\n      case \"projects\":\n        rooms[key] = createProjectRoom(PROJECTS_ROOM_OPTIONS);\n        return rooms[key]!;\n      default:\n        throw new Error(`Unknown Room key ${key}`);\n    }\n  };\n\n  const loadRoom = async (key: RoomKey) => {\n    if (!loader) return;\n\n    const assets = roomAssets[key];\n    if (!assets)\n      throw new Error(\n        \"[Room Controller] sufficient asset meta data is not given.\"\n      );\n\n    if (!rooms[key]) {\n      const room: Room = instantiateRoom(key);\n\n      console.log(\"load room\", roomAssets[key]);\n\n      const loadItems = [...roomAssets[key].meshes];\n      if (roomAssets[key].hdr) loadItems.push(roomAssets[key].hdr);\n\n      //Load only once\n      await loader.load(loadItems);\n\n      if (room) {\n        room.mount();\n        room.isLoaded = true;\n        activeRoom = room;\n      }\n    }\n  };\n\n  const switchRoom = async (key: RoomKey): Promise<void> => {\n    if (activeRoomKey === key) return;\n    eventBusManager.loadingBus.emit({\n      type: \"load:start\",\n      loaded: 0,\n      total: 0,\n      url: \"\",\n    });\n\n    if (activeRoomKey != null) {\n      if (rooms[activeRoomKey] != null) rooms[activeRoomKey]!.setDeactive();\n    }\n\n    await loadRoom(key);\n\n    if (rooms[key]) rooms[key].setActive();\n    activeRoomKey = key;\n    activeRoom = rooms[key];\n\n    eventBusManager.loadingBus.emit({ type: \"load:complete\" });\n  };\n\n  const _loadPlayer = async (): Promise<void> => {\n    await loader?.load([PLAYER_ASSET]);\n    animationManager.mount(\"Player\", storage, inputsManager);\n  };\n\n  const mount = async (): Promise<void> => {\n    logger.onMount({ origin: \"Room Controller\" });\n    initializeLoader();\n    await _loadPlayer();\n    await loadRoom(\"navigation\");\n    await switchRoom(\"navigation\");\n  };\n\n  const update = (deltaTime: number) => {\n    activeRoom?.update(deltaTime);\n    animationManager.update(deltaTime);\n  };\n\n  const unmount = (): void => {\n    loader?.dispose();\n\n    Object.values(rooms).forEach((room) => {\n      room?.unmount();\n    });\n\n    logger.onUnmount({ origin: \"room-controller\" });\n  };\n\n  const transitionRooms = (key: RoomKey) => {\n    eventBusManager.loadingBus.emit({\n      type: \"load:start\",\n      loaded: 0,\n      total: 0,\n      url: \"\",\n    });\n\n    Promise.allSettled([switchRoom(key)]).then(() => {\n      eventBusManager.loadingBus.emit({ type: \"load:complete\" });\n    });\n  };\n\n  const deactivateRoom = () => {\n    if (!activeRoomKey) return;\n\n    activeRoom?.setDeactive();\n  };\n\n  return {\n    mount: mount,\n    switchRoom: {\n      navigation: () => transitionRooms(\"navigation\"),\n      about: () => transitionRooms(\"about\"),\n      projects: () => transitionRooms(\"projects\"),\n      default: () => deactivateRoom(),\n    },\n    update: update,\n    unmount: unmount,\n  };\n};\n"]}