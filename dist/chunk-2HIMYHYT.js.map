{"version":3,"sources":["../src/graphics/gameplay/player.ts"],"sourcesContent":["import { getGlobalContext } from \"@utils/globalContext\";\nimport { AnimationMixer, Euler, Object3D, Scene, Vector3 } from \"three\";\nimport { getControllers } from \"./controllers/controller\";\n\nexport interface PlayerProps {\n  ids: {\n    rootMesh: string;\n  };\n}\n\nexport interface PlayerContext {\n  scene: Scene;\n}\n\nexport interface Player {\n  create: () => void;\n  update: (\n    deltaTime: number,\n    rotation: {\n      yaw: number;\n      pitch: number;\n    }\n  ) => {\n    position: Vector3;\n    rotation: Euler;\n  };\n  destroy: () => void;\n}\n\ninterface PlayerState {\n  direction: Vector3;\n  velocity: Vector3;\n  rotationApplied: {\n    yaw: number;\n    pitch: number;\n  };\n}\n\ninterface ObjectReferences {\n  playerRoot: Object3D;\n}\n\ninterface Animation {\n  mixer: AnimationMixer | null;\n}\n\nconst PLAYER_CONSTANTS = {\n  MOVEMENT_ACCELERATION: 0.05,\n  MAX_VELOCITY: 0.05,\n};\n\ninterface TempData {\n  inputDirection: Vector3;\n}\n\nexport const createPlayer = (\n  props: PlayerProps,\n  context: PlayerContext\n): Player => {\n  const { scene } = context;\n  const { eventBusManager, globalState, globalStorage } = getGlobalContext();\n\n  let state: PlayerState = {\n    direction: new Vector3(0, 0, -1),\n    velocity: new Vector3(0, 0, 0),\n    rotationApplied: {\n      pitch: 0,\n      yaw: 0,\n    },\n  };\n  let tempData: TempData = {\n    inputDirection: new Vector3(0, 0, 0),\n  };\n  let inputs = getControllers();\n\n  let objects: ObjectReferences;\n  let animations: Animation;\n\n  const create = () => {\n    try {\n      let playerRoot = scene.getObjectByName(props.ids.rootMesh);\n\n      // const playerRoot=scene.getObjectByName(props.ids.rootMesh) as Object3D;\n\n      if (!playerRoot) {\n        throw new Error(\n          `player doesn't exist for the id ${props.ids.rootMesh}`\n        );\n      }\n\n      //Local References\n      objects = {\n        playerRoot: playerRoot,\n      };\n\n      animations = {\n        mixer: new AnimationMixer(playerRoot),\n      };\n    } catch (err) {\n      console.error(`Player mesh cant be obtained :${err}`);\n    }\n  };\n\n  const updateMouse = (mouse: { yaw: number; pitch: number }) => {\n    state.rotationApplied = mouse;\n    objects.playerRoot.rotation.y += state.rotationApplied.yaw;\n  };\n\n  const updateKeyboard = (deltaTime: number) => {\n    const { inputDirection } = tempData;\n    inputDirection.set(0, 0, 0);\n\n    if (inputs.getController(\"keyboard\")!.isKeyPressed(\"w\")) {\n      inputDirection.z += 1;\n    }\n\n    if (inputs.getController(\"keyboard\")!.isKeyPressed(\"s\")) {\n      inputDirection.z -= 1;\n    }\n\n    if (inputs.getController(\"keyboard\")!.isKeyPressed(\"a\")) {\n      inputDirection.x += 1;\n    }\n\n    if (inputs.getController(\"keyboard\")!.isKeyPressed(\"d\")) {\n      inputDirection.x -= 1;\n    }\n\n    if (inputDirection.length() > 0) {\n      inputDirection.normalize();\n    }\n\n    if (inputDirection.length() > 0) {\n      //accelerate towards the direction\n\n      state.velocity.add(\n        inputDirection.multiplyScalar(\n          PLAYER_CONSTANTS.MOVEMENT_ACCELERATION * deltaTime\n        )\n      );\n\n      state.velocity.clampLength(0, PLAYER_CONSTANTS.MAX_VELOCITY);\n    } else if (state.velocity.length() > 0) {\n      state.velocity.multiplyScalar(\n        1 - PLAYER_CONSTANTS.MOVEMENT_ACCELERATION * deltaTime\n      );\n    }\n\n    objects.playerRoot.position.add(state.velocity);\n  };\n\n  const updateControllers = (\n    deltaTime: number,\n    rotation: { yaw: number; pitch: number }\n  ) => {\n    updateMouse(rotation);\n    updateKeyboard(deltaTime);\n  };\n\n  const updateAnimation = (deltaTime: number) => {\n    animations.mixer!.update(deltaTime);\n  };\n\n  const update = (\n    deltaTime: number,\n    rotation: { yaw: number; pitch: number }\n  ) => {\n    if (animations.mixer) {\n      updateAnimation(deltaTime);\n    }\n\n    updateControllers(deltaTime, rotation);\n\n    return {\n      position: objects.playerRoot.position,\n      rotation: objects.playerRoot.rotation,\n    };\n  };\n\n  const destroy = () => {\n    try {\n      objects.playerRoot.clear();\n    } catch (err) {\n      console.error(`Error while destroy player ${err}`);\n    }\n  };\n\n  return {\n    create: create,\n    update: update,\n    destroy: destroy,\n  };\n};\n"],"mappings":"gFACA,OAAS,kBAAAA,EAAwC,WAAAC,MAAe,QA6ChE,IAAMC,EAAmB,CACvB,sBAAuB,IACvB,aAAc,GAChB,EAMaC,EAAe,CAC1BC,EACAC,IACW,CACX,GAAM,CAAE,MAAAC,CAAM,EAAID,EACZ,CAAE,gBAAAE,EAAiB,YAAAC,EAAa,cAAAC,CAAc,EAAIC,EAAiB,EAErEC,EAAqB,CACvB,UAAW,IAAIC,EAAQ,EAAG,EAAG,EAAE,EAC/B,SAAU,IAAIA,EAAQ,EAAG,EAAG,CAAC,EAC7B,gBAAiB,CACf,MAAO,EACP,IAAK,CACP,CACF,EACIC,EAAqB,CACvB,eAAgB,IAAID,EAAQ,EAAG,EAAG,CAAC,CACrC,EACIE,EAASC,EAAe,EAExBC,EACAC,EAEEC,EAAS,IAAM,CACnB,GAAI,CACF,IAAIC,EAAab,EAAM,gBAAgBF,EAAM,IAAI,QAAQ,EAIzD,GAAI,CAACe,EACH,MAAM,IAAI,MACR,mCAAmCf,EAAM,IAAI,QAAQ,EACvD,EAIFY,EAAU,CACR,WAAYG,CACd,EAEAF,EAAa,CACX,MAAO,IAAIG,EAAeD,CAAU,CACtC,CACF,OAASE,EAAK,CACZ,QAAQ,MAAM,iCAAiCA,CAAG,EAAE,CACtD,CACF,EAEMC,EAAeC,GAA0C,CAC7DZ,EAAM,gBAAkBY,EACxBP,EAAQ,WAAW,SAAS,GAAKL,EAAM,gBAAgB,GACzD,EAEMa,EAAkBC,GAAsB,CAC5C,GAAM,CAAE,eAAAC,CAAe,EAAIb,EAC3Ba,EAAe,IAAI,EAAG,EAAG,CAAC,EAEtBZ,EAAO,cAAc,UAAU,EAAG,aAAa,GAAG,IACpDY,EAAe,GAAK,GAGlBZ,EAAO,cAAc,UAAU,EAAG,aAAa,GAAG,IACpDY,EAAe,GAAK,GAGlBZ,EAAO,cAAc,UAAU,EAAG,aAAa,GAAG,IACpDY,EAAe,GAAK,GAGlBZ,EAAO,cAAc,UAAU,EAAG,aAAa,GAAG,IACpDY,EAAe,GAAK,GAGlBA,EAAe,OAAO,EAAI,GAC5BA,EAAe,UAAU,EAGvBA,EAAe,OAAO,EAAI,GAG5Bf,EAAM,SAAS,IACbe,EAAe,eACbxB,EAAiB,sBAAwBuB,CAC3C,CACF,EAEAd,EAAM,SAAS,YAAY,EAAGT,EAAiB,YAAY,GAClDS,EAAM,SAAS,OAAO,EAAI,GACnCA,EAAM,SAAS,eACb,EAAIT,EAAiB,sBAAwBuB,CAC/C,EAGFT,EAAQ,WAAW,SAAS,IAAIL,EAAM,QAAQ,CAChD,EAEMgB,EAAoB,CACxBF,EACAG,IACG,CACHN,EAAYM,CAAQ,EACpBJ,EAAeC,CAAS,CAC1B,EAEMI,EAAmBJ,GAAsB,CAC7CR,EAAW,MAAO,OAAOQ,CAAS,CACpC,EA0BA,MAAO,CACL,OAAQP,EACR,OA1Ba,CACbO,EACAG,KAEIX,EAAW,OACbY,EAAgBJ,CAAS,EAG3BE,EAAkBF,EAAWG,CAAQ,EAE9B,CACL,SAAUZ,EAAQ,WAAW,SAC7B,SAAUA,EAAQ,WAAW,QAC/B,GAcA,QAXc,IAAM,CACpB,GAAI,CACFA,EAAQ,WAAW,MAAM,CAC3B,OAASK,EAAK,CACZ,QAAQ,MAAM,8BAA8BA,CAAG,EAAE,CACnD,CACF,CAMA,CACF","names":["AnimationMixer","Vector3","PLAYER_CONSTANTS","createPlayer","props","context","scene","eventBusManager","globalState","globalStorage","getGlobalContext","state","Vector3","tempData","inputs","getControllers","objects","animations","create","playerRoot","AnimationMixer","err","updateMouse","mouse","updateKeyboard","deltaTime","inputDirection","updateControllers","rotation","updateAnimation"]}